rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ──────────── Common Functions ──────────── */

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isValidXPIncrease() {
      let newXP = request.resource.data.get('weeklyXp', 0);
      let oldXP = resource.data.get('weeklyXp', 0);
      let delta = newXP - oldXP;
      return delta >= 0 && delta <= 500;
    }

    /* ──────────── Users Root (Leaderboard için okunabilir) ──────────── */

    match /users/{uid} {
      // Leaderboard sorgusu için herkes (authenticated) okuyabilir
      allow read: if isAuthenticated();

      // Sadece owner yazabilir
      allow write: if isOwner(uid);
    }

    /* ──────────── Profile Subcollection ──────────── */

    match /users/{uid}/profile/{doc} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) && isValidXPIncrease();
      allow delete: if isOwner(uid);
    }

    /* ──────────── Progress & Sessions & Diğer Subcollections ──────────── */

    match /users/{uid}/{collection}/{doc} {
      allow read, write: if isOwner(uid);
    }

    /* ──────────── Leaderboard (Admin SDK Only Write) ──────────── */

    match /leaderboard/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    /* ──────────── App Config (Read Only) ──────────── */

    match /app_config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    /* ──────────── Default Deny ──────────── */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}